---
export const prerender = false;
import CodeEditor from "../../components/CodeEditor";
import TreeViewEditor from "../../components/TreeViewEditor";
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
	serverSideVerifyId,
	serverSideGetEditFileMetadata,
} from "../../lib/server/request";
const { id } = Astro.params;
if (!id) return Astro.redirect("/edit/error");
const forceNbt = Astro.url.searchParams.get("forceNbt") === "true";
const result = await serverSideVerifyId(id);
if (!result.valid || result.edited) return Astro.redirect("/edit/error");

const metadata = await serverSideGetEditFileMetadata(id);
if (!metadata) return Astro.redirect("/edit/error");

const title = "Editing " + metadata.filename;
---

<BaseLayout title={title}>
	<div
		class="dark:text-white text-black dark:bg-black bg-white flex flex-col h-full w-full"
	>
		<div
			class="border-b dark:border-gray-700 border-gray-300 px-4 pt-4 pb-1"
		>
			<div class="flex items-center gap-3">
				<h1 class="text-xl font-bold">{metadata.filename}</h1>
				{
					metadata.isNBT && (
						<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300">
							NBT
						</span>
					)
				}
			</div>
			<div class="flex gap-1 items-center mt-1">
				{
					metadata.isForce && (
						<span class="text-neutral-700 dark:text-neutral-400">
							Direct Mode
						</span>
					)
				}
				{
					metadata.isDiff && (
						<span class="text-green-700 dark:text-green-400">
							Diff Mode
						</span>
					)
				}
			</div>
		</div>
		<div class="flex-1 flex flex-col">
			{
				metadata.isNBT || forceNbt ? (
					<TreeViewEditor
						id={id}
						isDiff={metadata.isDiff}
						filename={metadata.filename}
						client:load
					/>
				) : (
					<CodeEditor metadata={metadata} id={id} client:load />
				)
			}
		</div>
	</div>
</BaseLayout>
